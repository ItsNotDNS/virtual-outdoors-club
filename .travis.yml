language: node_js
dist: trusty
node_js:
- lts/carbon
addons:
  postgresql: '9.5'
  chrome: stable
  ssh_known_hosts: 199.116.235.142
env:
- DJANGO_VERSION=2.1.2 DB=postgresql DISPLAY=:99.0 CHROME_BIN=/usr/bin/google-chrome
  DJANGO_HOST=http://127.0.0.1:8000/api
install:
- npm install
- pyenv global 3.6.3
- pip install --upgrade pip
- pip install -r requirements.txt
before_script:
- sh -e /etc/init.d/xvfb start
- psql -c "CREATE DATABASE outdoors_club_db"
- python src/django/manage.py migrate
- python src/django/manage.py createworker
script:
# encryption of cybera
- openssl aes-256-cbc -K $encrypted_de17c20e6bb1_key -iv $encrypted_de17c20e6bb1_iv -in key_outdoors.pem.enc -out /tmp/key_outdoors.pem -d
- eval "$(ssh-agent -s)"
- echo "$SSH_AUTH_SOCK"
# encryption of git
# - openssl aes-256-cbc -K $encrypted_de17c20e6bb1_key -iv $encrypted_de17c20e6bb1_iv -in deploy_rsa.enc -out ../.ssh/deploy_rsa -d
- chmod 600 /tmp/key_outdoors.pem
- ssh-add /tmp/key_outdoors.pem
- scp README.md ubuntu@199.116.235.142:/home/ubuntu
- ssh -i /tmp/key_outdoors.pem ubuntu@199.116.235.142
- kill $(lsof -ti :4444)
- kill $(lsof -ti :8000)
- kill $(lsof -ti :8081)
- nohup python src/django/manage.py runserver 0.0.0.0:8000 &
- python src/django/manage.py process_tasks &
# - coverage run --source='src/django/api/views/' --omit='src/django/api/views/PayPalView.py'
#   src/django/manage.py test api
# - coverage report --fail-under=70
# - npm run-script lint
# - npm test -- --single-run
# after_success:
